stages:
  - build
  - update-gitops

variables:
  REGISTRY: "localhost:31270"
  IMAGE: "$REGISTRY/myapp"

build:
  stage: build
  image: docker:20.10.16
  services:
    - docker:20.10.16-dind
  before_script:
    - docker info
  script:
    - docker build -t $IMAGE:$CI_COMMIT_SHORT_SHA .
    - docker tag $IMAGE:$CI_COMMIT_SHORT_SHA $IMAGE:dev
    - docker push $IMAGE:dev
  only:
    - main

update-gitops:
  stage: update-gitops
  image: alpine:3.18
  before_script:
    - apk add --no-cache git openssh
  script:
    - git clone git@gitlab.com:YOURUSERNAME/gitops-repo.git
    - cd gitops-repo/dev
    - sed -i "s|image: .*|image: localhost:31270/myapp:dev|g" myapp.yaml || true
    - git add myapp.yaml
    - git commit -m "ci: update image to $CI_COMMIT_SHORT_SHA" || echo "no changes"
    - git push origin main
  only:
    - main
